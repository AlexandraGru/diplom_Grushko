"""Add 200 services for existing self-employed users

Revision ID: a1b2c3d4e5f6
Revises: dbf17d2f10c7
Create Date: 2025-12-16 12:00:00.000000

"""
from typing import Sequence, Union
import uuid
import random
from decimal import Decimal

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'a1b2c3d4e5f6'
down_revision: Union[str, None] = 'dbf17d2f10c7'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

# Названия услуг самозанятых для генерации
PRODUCT_NAMES = [
    'Консультация по налогам', 'Бухгалтерское обслуживание', 'Ведение учета', 'Подготовка отчетности', 'Налоговое планирование',
    'Юридическая консультация', 'Составление договоров', 'Регистрация ИП', 'Регистрация ООО', 'Ликвидация компании',
    'Разработка сайта', 'Веб-дизайн', 'Верстка сайта', 'Настройка CMS', 'SEO-оптимизация',
    'SMM-продвижение', 'Ведение соцсетей', 'Создание контента', 'Реклама в интернете', 'Email-маркетинг',
    'Программирование на Python', 'Программирование на Java', 'Программирование на JavaScript', 'Разработка мобильных приложений', 'Тестирование ПО',
    'Дизайн логотипа', 'Фирменный стиль', 'Дизайн полиграфии', 'Дизайн упаковки', '3D-визуализация',
    'Фотосъемка', 'Видеосъемка', 'Обработка фотографий', 'Монтаж видео', 'Создание роликов',
    'Копирайтинг', 'Рерайтинг', 'Перевод текстов', 'Корректура текста', 'Редактура',
    'Обучение английскому языку', 'Обучение программированию', 'Онлайн-курсы', 'Репетиторство', 'Подготовка к ЕГЭ',
    'Уроки музыки', 'Уроки рисования', 'Уроки танцев', 'Йога', 'Фитнес-тренер',
    'Парикмахерские услуги', 'Маникюр', 'Педикюр', 'Наращивание ресниц', 'Макияж',
    'Массаж классический', 'Массаж лечебный', 'Массаж релакс', 'SPA-процедуры', 'Косметология',
    'Ремонт компьютеров', 'Ремонт смартфонов', 'Установка ПО', 'Удаление вирусов', 'Настройка оборудования',
    'Услуги сантехника', 'Услуги электрика', 'Ремонт квартир', 'Отделочные работы', 'Сантехмонтаж',
    'Уборка квартир', 'Генеральная уборка', 'Уборка офисов', 'Химчистка', 'Мытье окон',
    'Доставка продуктов', 'Курьерские услуги', 'Переезды', 'Перевозка мебели', 'Грузоперевозки',
    'Услуги няни', 'Присмотр за детьми', 'Выгул собак', 'Уход за животными', 'Дрессировка собак',
    'Ремонт одежды', 'Пошив одежды', 'Ремонт обуви', 'Химчистка одежды', 'Стирка белья',
    'Приготовление еды', 'Организация праздников', 'Кейтеринг', 'Флористика', 'Украшение зала',
    'Услуги переводчика', 'Нотариальные услуги', 'Услуги оценщика', 'Услуги риелтора', 'Страхование',
    'Медицинская консультация', 'Массаж для детей', 'Логопед', 'Психолог', 'Коучинг',
    'Разработка бизнес-плана', 'Маркетинговое исследование', 'Аудит компании', 'Финансовый анализ', 'Инвестиционное консультирование',
    'Архитектурное проектирование', 'Дизайн интерьера', 'Ландшафтный дизайн', 'Проектирование зданий', 'Инженерные изыскания',
    'Консультация по инвестициям', 'Управление активами', 'Финансовое планирование', 'Оценка бизнеса', 'Сопровождение сделок',
    'HR-консультирование', 'Подбор персонала', 'Оценка персонала', 'Обучение сотрудников', 'Разработка должностных инструкций',
    'Маркетинговая стратегия', 'Брендинг', 'Позиционирование товара', 'Анализ конкурентов', 'Разработка маркетинговой кампании',
    'Настройка рекламы в Яндекс', 'Настройка рекламы в Google', 'Таргетированная реклама', 'Контекстная реклама', 'Ретаргетинг',
    'Создание инфографики', 'Анимация', 'Моушн-дизайн', 'Создание презентаций', 'Создание баннеров',
    'Написание статей', 'Ведение блога', 'Журналистика', 'Техническое описание', 'Пользовательские инструкции',
    'Аренда оборудования', 'Аренда помещения', 'Организация мероприятий', 'PR-услуги', 'Работа со СМИ',
    'Графический дизайн', 'Иллюстрация', 'Скетчинг', 'Дизайн интерфейсов', 'UX/UI дизайн',
    'Звукорежиссура', 'Запись подкастов', 'Озвучка', 'Музыкальная аранжировка', 'Написание музыки',
    'Административная поддержка', 'Виртуальный помощник', 'Обработка документов', 'Ввод данных', 'Архивирование',
    'Техническая поддержка', 'IT-консалтинг', 'Облачные решения', 'Настройка серверов', 'Кибербезопасность',
    'Логистика', 'Складирование', 'Таможенное оформление', 'Экспедирование', 'Управление цепями поставок',
    'Медицинская документация', 'Медицинское сопровождение', 'Реабилитация', 'Физиотерапия', 'Лечебная физкультура',
    'Онлайн-консультации', 'Телемедицина', 'Психологическая помощь онлайн', 'Онлайн-обучение', 'Виртуальные тренинги',
]


def upgrade() -> None:
    # Получаем подключение к базе данных
    connection = op.get_bind()
    
    # Получаем всех существующих пользователей
    result = connection.execute(
        sa.text("SELECT id FROM users")
    )
    users = [row[0] for row in result]
    
    if not users:
        # Если пользователей нет, выходим без ошибки
        print("Warning: No users found in database. Skipping service creation.")
        return
    
    # Создаем 200 услуг самозанятых
    products_data = []
    for i in range(200):
        # Выбираем случайного пользователя
        user_id = random.choice(users)
        
        # Генерируем данные услуги
        product_id = str(uuid.uuid4())
        name = random.choice(PRODUCT_NAMES)
        # Цена услуги от 500 до 50000 рублей, округленная до сотен
        price = Decimal(str(round(random.uniform(500.0, 50000.0), -2)))
        # Случайно определяем, исчисляемый ли продукт (80% - да)
        is_countable = random.random() < 0.8
        
        products_data.append({
            'id': product_id,
            'name': name,
            'price': price,
            'is_countable': is_countable,
            'user_id': user_id
        })
    
    # Вставляем услуги в базу данных
    for product in products_data:
        connection.execute(
            sa.text("""
                INSERT INTO products (id, name, price, is_countable, user_id)
                VALUES (:id, :name, :price, :is_countable, :user_id)
            """),
            {
                'id': product['id'],
                'name': product['name'],
                'price': product['price'],
                'is_countable': product['is_countable'],
                'user_id': product['user_id']
            }
        )
    
    connection.commit()


def downgrade() -> None:
    # Удаляем услуги, созданные этой миграцией
    # Так как мы не можем точно определить, какие именно услуги были созданы,
    # удаляем до 200 услуг
    # ВНИМАНИЕ: Это может удалить услуги, которые не были созданы этой миграцией,
    # если в базе уже были услуги до применения этой миграции
    
    connection = op.get_bind()
    
    # Получаем список ID услуг для удаления (до 200 штук)
    result = connection.execute(
        sa.text("SELECT id FROM products ORDER BY id LIMIT 200")
    )
    product_ids = [row[0] for row in result]
    
    if product_ids:
        # Удаляем услуги по списку ID одним запросом
        connection.execute(
            sa.text("DELETE FROM products WHERE id = ANY(:ids)"),
            {'ids': product_ids}
        )
        connection.commit()

